#! /bin/bash

START_TIME=$SECONDS
options=$@
arguments=($options)

#default options
threads=8
mem=8
outdir="StrainR_abundances"
prefix="sample"
weighted_percentile=60
subcontig_filter=0


#parse options
i=0
for argument in $options
  do
    i=$(( $i + 1 ))

    case $argument in
      -1 | --forward) forward="${arguments[i]}" ;;
      -2 | --reverse) reverse="${arguments[i]}" ;;
      -r | --reference) reference="${arguments[i]}" ;;
      -c | --weightedpercentile) weighted_percentile="${arguments[i]}" ;;
      -s | --subcontigfilter) subcontig_filter="${arguments[i]}" ;;
      -t | --threads) threads="${arguments[i]}" ;;
      -m | --mem) mem="${arguments[i]}" ;;
      -o | --outdir) outdir="${arguments[i]}" ;;
      -p | --prefix) prefix="${arguments[i]}" ;;
      -h | --help) 
              printf "USAGE: StrainR -1 path/to/forward.fastq.gz -2 path/to/reverse.fastq.gz -r path/to/reference/directory [OPTIONS]\n\
StrainR normalizes mapping from reads using the output from PreProcessR\n\
\tRequired Arguments:\n\
\t\t-1/--forward path/to/forward.fastq.gz\t\t: path to forward reads\n\
\t\t-2/--reverse path/to/reverse.fastq.gz\t\t: path to reverse reads\n\
\t\t-r/--reference path/to/reference/directory\t: path to the output directory generated by PreProcessR\n\
\tOptional Arguments:\n\
\t\t-c/--weightedpercentile number\t: Weighted percentile for a strain's FUKMs to use in abundance estimation [Default = 60]\n\
\t\t-s/--subcontigfilter number\t: Percentage of a strain's subcontigs that should be filtered out based on number of unique k-mers [Default = 0]\n\
\t\t-o/--outdir path/to/out\t\t: path to your output directory to contain normalized abundances [Default = current directory]\n\
\t\t-p/--prefix string\t\t: Name of community (used in output files) [Default = "sample"]\n\
\t\t-t/--threads number\t\t: number of threads to use when running fastp, bbmap, and samtools. Maximum is 16 [Default = 8]\n\
\t\t-m/--mem number\t\t\t: gigabytes of memory to use when running bbmap [Default = 8]\n\
\t\t-h/--help\t\t\t: Display this message\n"
            exit
            ;;
    esac
  done

if [ -z "$forward" ]; then
  echo "Error: Forward reads need to be provided with -1 or --forward. Use 'StrainR --help' for more info."
  exit
fi
if [ -z "$reverse" ]; then
  echo "Error: Reverse reads need to be provided with -1 or --reverse. Use 'StrainR --help' for more info."
  exit
fi
if [ -z "$reference" ]; then
  echo "Error: Reference directory needs to be provided with -r or --reference. Use 'StrainR --help' for more info."
  exit
fi
if [ -d "$outdir" ]; then
  echo "Error: Output directory already exists."
  exit
fi


mkdir "$outdir"
mkdir "$outdir"/tmp

#trim reads
echo Trimming Reads
fastp -i "$forward" -o "$outdir"/tmp/forward.fastq.gz \
  -I "$reverse" -O "$outdir"/tmp/reverse.fastq.gz \
  --trim_poly_g --json "$outdir" --html "$outdir" \
  --length_required 50 --n_base_limit 0 \
  --thread "$threads"

#map reads
echo Mapping Reads
bbmap.sh\
  in="$outdir"/tmp/forward.fastq.gz in2="$outdir"/tmp/reverse.fastq.gz \
  ref="$reference"/BBindex/BBIndex.fasta \
  out="$outdir"/"$prefix".sam \
  rpkm="$outdir"/"$prefix".rpkm \
  threads="$threads" deterministic=t averagepairdist=200 \
  -Xmx"$mem"g \
  perfectmode=t local=f ambiguous=toss pairedonly=t nodisk=t

samtools view --threads "$threads" -bS "$outdir"/"$prefix".sam | \
samtools sort --threads "$threads" -o "$outdir"/"$prefix".bam


rm "$outdir"/"$prefix".sam
rm -r "$outdir"/tmp

echo "Plotting normalized data"
if Plot.R -a "$outdir" -i "$reference" -p "$prefix" -c "$weighted_percentile" -s "$subcontig_filter"; then
  echo "StrainR complete"
  echo "Total Run Time: $((($SECONDS - $START_TIME)/60)) min $((($SECONDS - $START_TIME)%60)) sec"
  exit
fi
echo "Error: Failed to generate output files, exiting"
exit
